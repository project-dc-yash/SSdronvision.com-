<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Circuit Breaker & Busbar Detection</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f7fb; }
    header { margin-bottom:20px; }
    h1 { font-size:20px; margin:0; }
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:20px; }
    .cards { display:grid; gap:12px; }
    .card { background:white; padding:12px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.06); }
    .card h3 { margin:0 0 6px 0; font-size:14px; }
    .card p { margin:0; font-size:12px; color:#555; }
    .gallery { display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; }
    .thumb { text-align:center; background:#fff; padding:10px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .thumb img { width:120px; height:120px; border-radius:50%; object-fit:cover; }
    .thumb small { display:block; margin-top:6px; font-size:12px; color:#555; }
    #container{position:relative;margin-top:20px;}
    video,canvas{width:100%;max-width:720px;border-radius:12px;display:block;}
    #controls{margin-top:10px;}
    button{padding:8px 14px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer;}
    #log{margin-top:10px;font-size:12px;max-height:150px;overflow:auto;}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”Œ Circuit Breaker & Busbar Faults â€“ Live Detection</h1>
    <p>View sample images, read fault details, and run live camera-based detection.</p>
  </header>

  <main class="grid">
    <!-- Fault cards -->
    <section>
      <div class="cards">
        <div class="card">
          <h3>Short Circuit / Phase-to-Phase Fault</h3>
          <p>Large current flow due to insulation failure or equipment defect. Breaker trips instantly.</p>
        </div>
        <div class="card">
          <h3>Busbar Fault</h3>
          <p>Arcing or burning on busbar system, often due to overload, dust, or loose connections.</p>
        </div>
        <div class="card">
          <h3>Busbar (Normal)</h3>
          <p>Healthy busbar without faults. Regular inspection prevents failures.</p>
        </div>
      </div>
    </section>

    <!-- Gallery -->
    <aside>
      <h3>Gallery</h3>
      <div class="gallery">
        <div class="thumb">
          <img src="busbar_fault.png" alt="Busbar Fault">
          <small>Busbar Fault</small>
        </div>
        <div class="thumb">
          <img src="busbar.png" alt="Busbar Normal">
          <small>Busbar (Normal)</small>
        </div>
      </div>
    </aside>
  </main>

  <!-- Live Detection -->
  <section>
    <h3>ðŸ“· Live Camera Detection</h3>
    <div id="container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
    <div id="controls">
      <input id="serverUrl" type="text" value="http://localhost:8000/detect" style="width:300px">
      <button id="startBtn">Start Detection</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>
    <div id="log"></div>
  </section>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const serverUrlInput = document.getElementById('serverUrl');
    const logEl = document.getElementById('log');
    let stream = null, running = false, pollTimer=null;

    async function startCamera(){
      stream = await navigator.mediaDevices.getUserMedia({ video:true });
      video.srcObject = stream;
      await video.play();
      overlay.width = video.videoWidth; overlay.height = video.videoHeight;
    }

    function drawDetections(dets){
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);
      dets.forEach(d=>{
        const [x1,y1,x2,y2] = d.box;
        ctx.strokeStyle="red"; ctx.lineWidth=2;
        ctx.strokeRect(x1,y1,x2-x1,y2-y1);
        ctx.fillStyle="red"; ctx.font="14px Arial";
        ctx.fillText(d.label+" "+(d.confidence*100).toFixed(1)+"%", x1, y1-5);
      });
    }

    async function sendFrame(){
      const tmp=document.createElement('canvas');
      tmp.width=video.videoWidth*0.6; tmp.height=video.videoHeight*0.6;
      tmp.getContext('2d').drawImage(video,0,0,tmp.width,tmp.height);
      const blob=await new Promise(r=>tmp.toBlob(r,'image/jpeg',0.8));
      const fd=new FormData(); fd.append('image',blob,'frame.jpg');
      try{
        const resp=await fetch(serverUrlInput.value,{method:'POST',body:fd});
        const j=await resp.json();
        if(j.detections){ drawDetections(j.detections); log("Detections: "+j.detections.map(d=>d.label).join(", ")); }
      }catch(err){ log("Error: "+err.message); }
    }

    function log(msg){ const line=document.createElement('div'); line.textContent=msg; logEl.prepend(line); }

    startBtn.onclick=async()=>{
      if(!stream) await startCamera();
      running=true; startBtn.disabled=true; stopBtn.disabled=false;
      pollTimer=setInterval(()=>{ if(running) sendFrame(); },1000);
    };
    stopBtn.onclick=()=>{
      running=false; stopBtn.disabled=true; startBtn.disabled=false;
      if(pollTimer) clearInterval(pollTimer);
    };
  </script>
</body>
</html>
